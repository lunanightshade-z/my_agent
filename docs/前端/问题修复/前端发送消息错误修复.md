# 前端发送消息错误修复

## 问题描述

部署后前端发送消息时出现以下错误：
```
Uncaught TypeError: e is not a function
    at b (index-ClsNHCJV.js:218:5705)
```

## 问题分析

经过代码审查，发现两个主要问题：

### 1. API 模块导出/导入不一致

**问题位置：** `frontend/src/services/api.js`

**问题原因：**
- 文件同时使用了命名导出（`export const`）和默认导出（`export default`）
- 在构建打包时，某些情况下可能导致命名导入解析失败，函数变成 `undefined`
- 当调用 `undefined` 的函数时，就会报错 `e is not a function`（压缩后的变量名）

**修复方案：**
- 移除默认导出，统一使用命名导出
- 确保所有导入都使用命名导入方式

### 2. InputBox 组件 prop 名称不匹配

**问题位置：** `frontend/src/pages/Chat.jsx`

**问题原因：**
- `InputBox` 组件期望接收 `onSend` prop
- 但在 `Chat.jsx` 中传递的是 `onSendMessage` prop
- 导致 `onSend` 为 `undefined`，调用时报错

**修复方案：**
- 将 `onSendMessage` 改为 `onSend`，与组件定义保持一致

## 修复内容

### 1. 修复 API 服务导出问题

**文件：** `frontend/src/services/api.js`

**修改：**
- 移除了文件末尾的默认导出对象
- 保留所有命名导出（`export const`）
- 改进了流式读取的错误处理，添加了 `.catch()` 处理读取错误

**修改前：**
```javascript
export default {
  createConversation,
  getConversations,
  deleteConversation,
  getConversationMessages,
  sendMessageStream,
  generateConversationTitle,
  updateConversationTitle,
};
```

**修改后：**
- 移除了默认导出
- 改进了 `readStream` 的错误处理

### 2. 修复 InputBox prop 名称

**文件：** `frontend/src/pages/Chat.jsx`

**修改：**
```javascript
// 修改前
<InputBox onSendMessage={handleSendMessage} disabled={isStreaming} />

// 修改后
<InputBox onSend={handleSendMessage} disabled={isStreaming} />
```

### 3. 改进错误处理

**文件：** `frontend/src/services/api.js`

**改进：**
- 在 `readStream` 的 Promise 链中添加了 `.catch()` 处理
- 确保流读取过程中的错误能被正确捕获和处理

## 后续修复（2024-01-12）

### 问题1：生成标题 API 返回 422 错误

**错误信息：**
```
POST http://8.130.129.37:28888/api/conversations/1/generate-title?first_message=... 422 (Unprocessable Entity)
```

**问题原因：**
- 后端 API 期望在请求体（body）中接收 JSON 数据
- 前端代码错误地使用了 query parameters (`params`)
- FastAPI 的 Pydantic 模型无法从 query params 中解析数据，导致 422 错误

**修复内容：**

1. **修复 `generateConversationTitle` 函数：**
   ```javascript
   // 修改前（错误）
   export const generateConversationTitle = async (conversationId, firstMessage) => {
     const response = await apiClient.post(`/conversations/${conversationId}/generate-title`, null, {
       params: { first_message: firstMessage }
     });
     return response.data;
   };
   
   // 修改后（正确）
   export const generateConversationTitle = async (conversationId, firstMessage) => {
     const response = await apiClient.post(`/conversations/${conversationId}/generate-title`, {
       first_message: firstMessage
     });
     return response.data;
   };
   ```

2. **修复 `updateConversationTitle` 函数：**
   ```javascript
   // 修改前（错误）
   export const updateConversationTitle = async (conversationId, title) => {
     const response = await apiClient.put(`/conversations/${conversationId}/title`, null, {
       params: { title }
     });
     return response.data;
   };
   
   // 修改后（正确）
   export const updateConversationTitle = async (conversationId, title) => {
     const response = await apiClient.put(`/conversations/${conversationId}/title`, {
       title: title
     });
     return response.data;
   };
   ```

**后端 API 期望格式：**
- `TitleGenerationRequest`: `{ "first_message": "..." }` (POST body)
- `TitleUpdateRequest`: `{ "title": "..." }` (PUT body)

### 问题2：发送消息无回复 - 错误信息未正确传递

**问题现象：**
- 发送消息后没有任何回复
- 后端日志显示智谱AI API连接失败：`"error": "Connection error.", "error_type": "APIConnectionError"`
- HTTP 请求返回 200，但前端没有收到错误信息

**问题原因：**
- 后端返回的错误格式是 `{"type": "error", "content": "..."}`
- 前端代码检查的是 `parsed.error`，应该检查 `parsed.content`
- 导致错误信息没有被正确处理和显示

**修复内容：**

**文件：** `frontend/src/services/api.js`

```javascript
// 修改前（错误）
} else if (parsed.type === 'error') {
  onError(parsed.error || '未知错误');
}

// 修改后（正确）
} else if (parsed.type === 'error') {
  onError(parsed.content || parsed.error || '未知错误');
}
```

**后端错误格式：**
- `chat_service.py`: `{"type": "error", "content": f"处理失败: {str(e)}"}`
- `zhipu_client.py`: `{"type": "error", "content": f"调用失败: {str(e)}"}`
- `chat.py`: `{"type": "error", "content": str(e)}`

## 验证方法

1. **重新构建前端：**
   ```bash
   cd /home/superdev/my_agent/frontend
   npm run build
   ```
   
   **注意：** 必须在 `frontend` 目录下运行构建命令，因为 `package.json` 在该目录下。

2. **构建验证：**
   - 构建成功后会生成 `dist/` 目录
   - 检查 `dist/index.html` 和 `dist/assets/` 目录是否存在
   - 确认构建过程中没有错误

3. **测试发送消息功能：**
   - 部署构建后的 `dist/` 目录
   - 打开聊天页面
   - 输入消息并发送
   - 确认不再出现 `e is not a function` 错误
   - 确认消息能正常发送和接收
   - **如果API连接失败，应该显示错误提示而不是没有任何反应**

4. **检查浏览器控制台：**
   - 确认没有 JavaScript 错误
   - 确认 API 调用正常
   - 如果API失败，应该看到错误提示

5. **检查后端日志：**
   ```bash
   docker logs ai_agent_api --tail 50
   ```
   - 查看是否有 `llm_call_failed` 或 `chat_failed` 日志
   - 确认错误信息是否正确记录

## 构建结果

✅ **最新构建成功**
- 构建时间：约 5.53 秒
- 输出文件：
  - `dist/index.html` (0.58 kB)
  - `dist/assets/index-hx1a7CcL.js` (1,139.78 kB)
  - `dist/assets/index-DJhgio2t.css` (35.42 kB)
- 构建状态：无错误，无警告（仅有性能优化建议）

## 相关文件

- `frontend/src/services/api.js` - API 服务模块
- `frontend/src/pages/Chat.jsx` - Chat 页面组件
- `frontend/src/components/InputBox.jsx` - 输入框组件
- `frontend/src/components/ChatMain.jsx` - 聊天主组件（已正确使用 `onSend`）
- `backend/app/services/chat_service.py` - 聊天服务层
- `backend/app/infrastructure/llm/zhipu_client.py` - LLM 客户端

## 注意事项

1. **导出方式一致性：**
   - 建议统一使用命名导出（`export const`）或默认导出（`export default`）
   - 避免混用两种导出方式，可能导致构建工具解析问题

2. **Prop 名称一致性：**
   - 组件定义和使用的 prop 名称必须完全一致
   - 建议使用 TypeScript 或 PropTypes 进行类型检查，提前发现此类问题

3. **错误处理：**
   - 所有异步操作都应该有错误处理
   - 特别是流式操作，需要确保错误能被正确捕获
   - 确保错误信息的字段名称与后端一致（`content` vs `error`）

4. **API 参数格式：**
   - 确认后端 API 期望的参数格式（body vs query params）
   - 使用 FastAPI 时，Pydantic 模型通常期望 body 中的 JSON 数据

5. **网络连接问题：**
   - 如果智谱AI API连接失败，检查：
     - API Key 是否正确配置
     - 网络连接是否正常
     - API 服务是否可用

## 修复日期

2024-01-12
