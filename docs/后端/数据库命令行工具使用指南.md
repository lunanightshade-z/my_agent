# 数据库命令行工具使用指南

## 概述

数据库命令行工具 (`db_cli`) 是一个交互式的数据库查询和管理工具，用于查看和管理聊天记录数据。支持多种查询功能，包括用户统计、会话查询、消息搜索和数据导出。

## 功能特性

### 📊 统计功能
- **整体统计**: 查看用户数、会话数、消息数等整体数据统计
- **活跃用户排行**: 按会话数和消息数排序的活跃用户排行榜

### 👥 用户功能
- **列出所有用户**: 查看所有用户及其会话数、消息数、最后活跃时间
- **查看用户会话**: 查看指定用户的所有会话列表
- **查看用户消息**: 查看指定用户的所有消息历史
- **搜索用户**: 根据用户ID关键词搜索用户

### 💬 会话功能
- **列出所有会话**: 查看所有会话，支持按类型过滤（chat/agent）
- **查看会话详情**: 查看指定会话的完整消息历史
- **搜索会话**: 根据标题关键词搜索会话

### 📨 消息功能
- **搜索消息**: 根据关键词搜索消息内容，支持按角色过滤
- **查看最近消息**: 查看最近的消息记录

### 💾 导出功能
- **导出会话为JSON**: 将指定会话导出为JSON格式
- **导出用户数据为JSON**: 将指定用户的所有数据导出为JSON格式
- **导出消息为CSV**: 将消息导出为CSV格式，支持按会话、用户或全部导出

## 使用方法

### 启动工具

#### 方式1: 直接运行主脚本
```bash
cd /home/superdev/my_agent
python scripts/db_cli/main.py
```

#### 方式2: 使用便捷入口脚本
```bash
cd /home/superdev/my_agent
python scripts/db_cli.py
```

#### 方式3: Docker环境
如果使用Docker部署，需要进入容器执行：
```bash
# 进入API容器
docker exec -it ai_agent_api bash

# 在容器内运行
cd /app
python scripts/db_cli/main.py
```

### 数据库路径

工具会自动查找数据库文件，按以下优先级：
1. `./data/chat_history.db` (Docker挂载目录)
2. `./backend/chat_history.db`
3. `./backend/data/chat_history.db`
4. 配置文件中的 `DATABASE_URL`

### 交互式菜单

启动工具后，会显示主菜单：

```
🗄️  数据库管理工具
📂 数据库路径: /path/to/chat_history.db

请选择功能:

📊 统计功能:
  1. 查看整体统计
  2. 查看活跃用户排行

👥 用户功能:
  3. 列出所有用户
  4. 查看用户会话
  5. 查看用户消息
  6. 搜索用户

💬 会话功能:
  7. 列出所有会话
  8. 查看会话详情
  9. 搜索会话（按标题）

📨 消息功能:
  10. 搜索消息（按关键词）
  11. 查看最近消息

💾 导出功能:
  12. 导出会话为JSON
  13. 导出用户数据为JSON
  14. 导出消息为CSV

  0. 退出
```

### 使用示例

#### 1. 查看整体统计
```
请输入选项: 1
```
显示用户数、会话数、消息数等统计信息。

#### 2. 查看用户列表
```
请输入选项: 3
限制数量 (留空显示全部): 20
```
显示前20个用户及其统计信息。

#### 3. 查看用户会话
```
请输入选项: 4
请输入用户ID: abc123-def456-ghi789
限制数量 (留空显示全部): 
```
显示该用户的所有会话。

#### 4. 查看会话详情
```
请输入选项: 8
请输入会话ID: 123
```
显示会话ID为123的完整消息历史。

#### 5. 搜索消息
```
请输入选项: 10
请输入搜索关键词: Python
角色过滤 (user/assistant，留空显示全部): 
限制数量 (默认20): 50
```
搜索包含"Python"的消息，显示最多50条。

#### 6. 导出会话
```
请输入选项: 12
请输入会话ID: 123
输出文件路径 (留空自动生成): 
```
导出会话为JSON文件，文件名自动生成。

## 项目结构

```
scripts/db_cli/
├── __init__.py              # 包初始化
├── main.py                  # 主程序入口
├── database.py              # 数据库连接管理
├── utils.py                 # 工具函数
└── commands/                # 命令模块
    ├── __init__.py
    ├── stats.py             # 统计命令
    ├── user.py              # 用户查询命令
    ├── conversation.py      # 会话查询命令
    ├── message.py           # 消息查询命令
    └── export.py            # 导出命令
```

## 技术实现

### 数据库连接
- 使用 SQLAlchemy ORM 进行数据库操作
- 自动检测数据库文件位置
- 支持 Docker 环境下的数据目录挂载

### 模块化设计
- 采用命令模式，每个功能模块独立
- 工具函数统一管理，便于复用
- 清晰的职责分离，易于维护和扩展

### 错误处理
- 完善的异常处理机制
- 友好的错误提示信息
- 自动资源清理（数据库连接）

## 注意事项

1. **数据库文件权限**: 确保有读取数据库文件的权限
2. **Docker环境**: 在Docker环境中运行时，确保数据目录已正确挂载
3. **大量数据**: 查询大量数据时可能需要较长时间，建议使用限制数量参数
4. **导出文件**: 导出文件会保存在当前工作目录，确保有写入权限

## 扩展功能

如需添加新功能，可以：
1. 在 `commands/` 目录下创建新的命令模块
2. 在 `main.py` 中添加菜单项和对应的处理逻辑
3. 使用 `utils.py` 中的工具函数保持代码一致性

## 故障排查

### 问题: 找不到数据库文件
**解决方案**: 
- 检查数据库文件是否存在
- 确认Docker数据目录挂载是否正确
- 检查配置文件中的 `DATABASE_URL`

### 问题: 导入模块失败
**解决方案**:
- 确保在项目根目录运行脚本
- 检查Python路径配置
- 确认所有依赖已安装

### 问题: 权限错误
**解决方案**:
- 检查数据库文件读取权限
- 检查导出目录写入权限
- 在Docker环境中检查挂载目录权限

## 更新日志

### v1.0.0 (2026-01-28)
- 初始版本发布
- 支持用户、会话、消息查询
- 支持数据统计和导出功能
- 交互式命令行界面
