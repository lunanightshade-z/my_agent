# Chat 页面多模型支持适配文档

**日期**: 2026-01-27  
**作者**: AI Assistant  
**版本**: 1.0

## 📋 概述

本次更新为 Chat 页面添加了多模型支持，用户现在可以在 Kimi 和智谱（ZhiPu）两个模型之间切换。默认模型为 Kimi。

## 🎯 实现目标

1. ✅ 支持 Kimi API（通过 OpenRouter）
2. ✅ 支持智谱 API
3. ✅ 前端添加模型选择器
4. ✅ 默认使用 Kimi 模型
5. ✅ 支持思考模式（Reasoning）

## 🏗️ 架构设计

### 后端架构

采用**工厂模式**统一管理不同的 LLM 客户端：

```
backend/app/infrastructure/llm/
├── zhipu_client.py          # 智谱 AI 客户端
├── openrouter_client.py     # OpenRouter 客户端（支持 Kimi）
└── llm_factory.py           # LLM 客户端工厂
```

### 核心组件

#### 1. OpenRouter 客户端 (`openrouter_client.py`)

新增的客户端，用于调用 Kimi 等通过 OpenRouter 提供的模型。

**主要功能**：
- 流式聊天响应
- 支持思考模式（Kimi 的 reasoning 功能）
- 缓存支持
- 自动重试
- 标题生成

**关键代码**：
```python
class OpenRouterClient:
    def __init__(self):
        self.client = OpenAI(
            base_url="https://openrouter.ai/api/v1",
            api_key=settings.OPENROUTER_API_KEY,
        )
    
    async def chat_stream(
        self,
        messages: List[Dict[str, str]],
        thinking: str = "disabled",
        model: Optional[str] = None,
        temperature: Optional[float] = None,
    ) -> AsyncGenerator[Dict[str, str], None]:
        # 流式响应实现
        ...
```

#### 2. LLM 客户端工厂 (`llm_factory.py`)

统一管理不同的 LLM 客户端，提供统一的接口。

**设计模式**：工厂模式（Factory Pattern）

**支持的提供商**：
- `kimi` / `openrouter` → OpenRouterClient
- `zhipu` → ZhipuClient

**关键代码**：
```python
class LLMFactory:
    PROVIDERS = {
        "zhipu": "zhipu",
        "kimi": "openrouter",
        "openrouter": "openrouter",
    }
    
    @classmethod
    def get_client(cls, provider: str = "kimi") -> LLMClient:
        # 根据提供商返回对应的客户端
        ...
```

#### 3. Chat 服务更新 (`chat_service.py`)

添加了 `model_provider` 参数支持。

**主要变更**：
```python
async def chat_stream(
    self,
    conversation_id: int,
    user_message: str,
    thinking_enabled: bool = False,
    user_id: str = None,
    model_provider: str = "kimi"  # 新增参数
) -> AsyncGenerator[Dict[str, str], None]:
    # 获取对应的 LLM 客户端
    llm_client = LLMFactory.get_client(model_provider)
    
    # 调用 LLM 流式响应
    async for chunk_data in llm_client.chat_stream(conversations, thinking_mode):
        yield chunk_data
```

#### 4. API Schema 更新 (`schemas.py`)

添加了 `model_provider` 字段。

```python
class ChatRequest(BaseModel):
    conversation_id: int
    message: str
    thinking_enabled: bool = False
    model_provider: str = Field(default="kimi", description="模型提供商（zhipu 或 kimi）")
```

### 前端架构

#### 1. Redux Store 更新 (`store.js`)

添加了 `modelProvider` 状态管理。

**新增状态**：
```javascript
initialState: {
    // ... 其他状态
    modelProvider: 'kimi',  // 默认使用 Kimi
}
```

**新增 Action**：
```javascript
setModelProvider: (state, action) => {
    state.modelProvider = action.payload;
}
```

#### 2. 模型选择器组件 (`ModelSelector.jsx`)

新增的 UI 组件，允许用户切换模型。

**特性**：
- 美观的渐变按钮
- 实时切换
- 流式响应时禁用切换
- Lucide 图标

**模型配置**：
```javascript
const models = [
    {
      id: 'kimi',
      name: 'Kimi',
      icon: Sparkles,
      description: '智能推理模型',
      color: 'from-purple-500 to-pink-500',
    },
    {
      id: 'zhipu',
      name: '智谱',
      icon: Zap,
      description: 'GLM-4 Flash',
      color: 'from-blue-500 to-cyan-500',
    },
];
```

#### 3. ChatMain 组件更新 (`ChatMain.jsx`)

集成模型选择器，传递模型参数到 API。

**主要变更**：
1. 导入 `ModelSelector` 组件
2. 从 Redux 获取 `modelProvider`
3. 在顶部工具栏显示模型选择器
4. 调用 API 时传递模型参数

#### 4. API 服务更新 (`api.js`)

`sendMessageStream` 函数新增 `modelProvider` 参数。

```javascript
export const sendMessageStream = (
    conversationId, 
    message, 
    thinkingEnabled, 
    modelProvider,  // 新增参数
    onThinking, 
    onChunk, 
    onDone, 
    onError
) => {
    // ...
    body: JSON.stringify({
        conversation_id: conversationId,
        message: message,
        thinking_enabled: thinkingEnabled,
        model_provider: modelProvider || 'kimi',  // 默认 Kimi
    }),
    // ...
}
```

## 🔧 配置变更

### 环境变量 (`.env`)

新增配置项：

```bash
# OpenRouter 配置（支持 Kimi 等模型）
OPENROUTER_API_KEY="sk-or-v1-..."
KIMI_MODEL="moonshotai/kimi-k2.5"
```

### 应用配置 (`config.py`)

新增配置项：

```python
# OpenRouter 配置（支持 Kimi 等模型）
OPENROUTER_API_KEY: str
KIMI_MODEL: str = "moonshotai/kimi-k2.5"
```

## 📝 使用说明

### 用户操作流程

1. **打开 Chat 页面**
2. **选择模型**：在顶部工具栏点击 Kimi 或智谱按钮
3. **发送消息**：输入消息并发送
4. **查看响应**：模型会根据选择的提供商生成回答

### 注意事项

- ⚠️ 在流式响应进行时，模型选择器会被禁用
- ✅ 默认使用 Kimi 模型
- ✅ 支持思考模式（在输入框旁边的开关）
- ✅ 模型切换会立即生效，影响下一次对话

## 🧪 测试

### 后端测试

创建了 `test_kimi_integration.py` 测试脚本：

```bash
python test_kimi_integration.py
```

**测试内容**：
1. ✅ Kimi 基本流式响应
2. ✅ Kimi 思考模式
3. ✅ 错误处理
4. ✅ 响应格式验证

### 前端测试

```bash
cd frontend
npm run build
```

**测试通过**：
- ✅ 语法检查通过
- ✅ 构建成功
- ✅ 无编译错误

## 🚀 部署

### 1. 更新依赖

后端依赖已包含在 `requirements.txt` 中：
```bash
openai>=1.70.0
```

### 2. 配置环境变量

确保 `.env` 文件包含：
```bash
OPENROUTER_API_KEY=your_key_here
KIMI_MODEL=moonshotai/kimi-k2.5
```

### 3. 重启服务

```bash
# 使用 Docker
docker-compose down
docker-compose up -d --build

# 或手动重启
cd backend && uvicorn app.main:app --reload
cd frontend && npm run dev
```

## 📊 技术亮点

### 1. 设计模式应用

- **工厂模式**：`LLMFactory` 统一管理不同的 LLM 客户端
- **单例模式**：客户端实例采用单例模式，避免重复创建
- **策略模式**：不同的 LLM 客户端实现统一的接口

### 2. 代码组织

- **职责分离**：客户端、工厂、服务层分离
- **易于扩展**：新增模型只需添加客户端并在工厂注册
- **统一接口**：所有客户端实现相同的方法签名

### 3. 用户体验

- **实时切换**：无需刷新页面即可切换模型
- **视觉反馈**：渐变按钮清晰标识当前选择
- **状态管理**：Redux 统一管理模型状态

## 🔍 问题排查

### 常见问题

1. **OpenRouter API 密钥无效**
   - 检查 `.env` 文件中的 `OPENROUTER_API_KEY`
   - 确认密钥格式正确（以 `sk-or-v1-` 开头）

2. **模型切换无响应**
   - 检查浏览器控制台是否有错误
   - 确认 Redux DevTools 中 `modelProvider` 状态是否更新

3. **Kimi 返回错误**
   - 检查网络连接
   - 确认 OpenRouter 账户余额充足
   - 查看后端日志

### 日志查看

后端日志会记录详细的 LLM 调用信息：

```python
logger.info(
    "llm_call_success",
    provider="openrouter",
    model=model,
    thinking=thinking,
    input_length=input_length,
    output_length=output_length,
    duration_ms=round(duration_ms, 2)
)
```

## 📈 后续优化建议

1. **添加更多模型**：
   - Claude
   - GPT-4
   - Gemini

2. **模型参数配置**：
   - Temperature 调节
   - Max tokens 设置
   - Top-p 控制

3. **性能优化**：
   - 响应缓存
   - 连接池管理
   - 请求合并

4. **用户体验**：
   - 模型描述工具提示
   - 响应速度显示
   - Token 使用统计

## 📚 参考资料

- [OpenRouter API 文档](https://openrouter.ai/docs)
- [Kimi API 文档](https://platform.moonshot.cn/docs)
- [FastAPI 官方文档](https://fastapi.tiangolo.com/)
- [React Redux 官方文档](https://react-redux.js.org/)

## 📝 变更日志

### Version 1.0 (2026-01-27)

**新增功能**：
- ✅ OpenRouter 客户端实现
- ✅ LLM 客户端工厂
- ✅ 模型选择器 UI 组件
- ✅ Redux 状态管理
- ✅ 默认使用 Kimi 模型

**修改内容**：
- ✅ Chat 服务支持模型选择
- ✅ API Schema 新增模型参数
- ✅ 前端 API 服务更新

**配置变更**：
- ✅ 新增环境变量配置
- ✅ 应用配置更新

---

**文档维护**: 请在后续更新时同步维护本文档
