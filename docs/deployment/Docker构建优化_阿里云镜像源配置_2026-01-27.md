# Docker 构建优化 - 阿里云镜像源配置

## 实施日期
2026-01-27

## 问题描述

在阿里云服务器上进行 Docker 构建时，出现耗时异常长的情况：
- `apt-get update` 步骤耗时 7-8 分钟
- 从 Debian 官方源下载包速度极慢
- 每次代码变更都需要重新执行耗时的系统包安装

## 根本原因

1. **未配置阿里云 Debian 镜像源**：`apt-get` 默认使用 Debian 官方源，在国内访问速度慢
2. **Docker 层缓存利用不佳**：系统包安装放在代码复制之后，导致每次代码变更都重新执行
3. **构建顺序不合理**：不常变的操作（系统包安装）应该放在前面，常变的操作（代码复制）放在后面

## 优化方案

### 1. 配置阿里云 Debian 镜像源

在 `apt-get update` 之前配置阿里云镜像源，大幅提升下载速度：

```dockerfile
# 配置阿里云 Debian 镜像源（加速 apt-get）
RUN sed -i 's/deb.debian.org/mirrors.aliyun.com/g' /etc/apt/sources.list.d/debian.sources && \
    sed -i 's|security.debian.org/debian-security|mirrors.aliyun.com/debian-security|g' /etc/apt/sources.list.d/debian.sources || \
    (echo "deb https://mirrors.aliyun.com/debian/ bookworm main" > /etc/apt/sources.list && \
     echo "deb https://mirrors.aliyun.com/debian/ bookworm-updates main" >> /etc/apt/sources.list && \
     echo "deb https://mirrors.aliyun.com/debian-security/ bookworm-security main" >> /etc/apt/sources.list)
```

**说明**：
- 兼容 Debian 12 (bookworm) 的新旧两种源配置方式
- 如果 `/etc/apt/sources.list.d/debian.sources` 存在则修改它
- 否则创建传统的 `/etc/apt/sources.list` 文件

### 2. 优化 Docker 层顺序

将系统包安装提前到代码复制之前，充分利用 Docker 缓存：

**优化前**：
```dockerfile
# 复制应用代码
COPY backend/app/ ./app/
COPY backend/agents/ ./agents/
COPY backend/tools/ ./tools/

# 安装cron和必要的工具（每次代码变更都要重新执行）
RUN apt-get update && apt-get install -y cron
```

**优化后**：
```dockerfile
# 配置镜像源并安装系统依赖（提前执行，利用Docker缓存）
RUN [配置镜像源] && apt-get update && apt-get install -y cron

# 复制应用代码（放在最后，代码变更时只重建这一层）
COPY backend/app/ ./app/
COPY backend/agents/ ./agents/
COPY backend/tools/ ./tools/
```

### 3. 优化后的完整构建顺序

1. **基础镜像和环境变量**（几乎不变）
2. **配置镜像源**（几乎不变）
3. **安装系统依赖**（几乎不变，利用缓存）
4. **配置 pip 镜像源**（几乎不变）
5. **安装 Python 依赖**（requirements.txt 变更时才重建）
6. **创建目录**（几乎不变）
7. **复制应用代码**（代码变更时重建，但前面的层都使用缓存）

## 预期效果

### 性能提升

- **apt-get update 时间**：从 7-8 分钟降低到 10-30 秒
- **首次构建时间**：减少约 7-8 分钟
- **增量构建时间**：代码变更时，系统包安装层使用缓存，无需重新下载

### 缓存利用率

- 系统包安装层：代码变更时 100% 使用缓存
- Python 依赖层：requirements.txt 不变时使用缓存
- 应用代码层：每次代码变更时重建（这是预期的）

## 验证方法

### 1. 验证镜像源配置

构建后进入容器检查：

```bash
docker build -t test-image .
docker run --rm test-image cat /etc/apt/sources.list
# 或
docker run --rm test-image cat /etc/apt/sources.list.d/debian.sources
```

应该看到 `mirrors.aliyun.com` 而不是 `deb.debian.org`。

### 2. 验证构建速度

```bash
# 首次构建（无缓存）
time docker compose build api

# 修改代码后再次构建（应该有缓存）
time docker compose build api
```

第二次构建应该明显更快，因为系统包安装层使用了缓存。

### 3. 验证缓存使用情况

```bash
docker compose build api --progress=plain
```

查看输出，应该看到 `CACHED` 标记的层。

## 相关文件

- `docker/Dockerfile` - 主 Dockerfile，已优化
- `docker-compose.yml` - Docker Compose 配置（无需修改）

## 注意事项

1. **镜像源兼容性**：配置同时支持新旧两种 Debian 源配置方式，确保在不同版本的 Debian 基础镜像上都能正常工作
2. **网络环境**：如果在非阿里云环境部署，可能需要调整镜像源地址
3. **缓存清理**：如果需要强制重新构建所有层，使用 `docker compose build --no-cache api`

## 后续优化建议

1. **多阶段构建**：如果构建过程复杂，考虑使用多阶段构建进一步优化
2. **构建参数**：对于不同环境，可以使用构建参数动态选择镜像源
3. **构建缓存挂载**：使用 BuildKit 的缓存挂载功能进一步加速构建
