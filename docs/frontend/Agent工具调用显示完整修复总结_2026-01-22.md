# Agent é¡µé¢å·¥å…·è°ƒç”¨æ˜¾ç¤ºé—®é¢˜ - å®Œæ•´ä¿®å¤æ€»ç»“

## é—®é¢˜é™ˆè¿°

ç”¨æˆ·æŠ¥å‘Šï¼š**Agenté¡µé¢è°ƒç”¨å·¥å…·æ—¶ï¼Œå‰ç«¯æ²¡æœ‰ä»»ä½•æ˜¾ç¤ºå·¥å…·è°ƒç”¨çš„å¡ç‰‡æˆ–ä¿¡æ¯ã€‚**

## æ ¹æœ¬åŸå› 

é€šè¿‡æ·±å…¥åˆ†æä»£ç æµç¨‹ï¼Œå‘ç°äº†ä»¥ä¸‹é—®é¢˜ï¼š

### 1. Redux Store æ•°æ®æ ¼å¼ä¸ä¸€è‡´

**é—®é¢˜ä½ç½®**: `frontend/src/store/store.js` - `addToolCall` action

```javascript
// åŸæœ‰é—®é¢˜
const toolCall = {
  ...action.payload,  // ç›´æ¥æ‰©å±•ï¼Œå¯èƒ½å¯¼è‡´å…³é”®å­—æ®µä¸¢å¤±
  id: Date.now() + Math.random(),
  isExecuting: true,
};
```

**é—®é¢˜æè¿°**:
- åç«¯å‘é€çš„æ•°æ®åŒ…å« `tool_name` å­—æ®µ
- Redux action æ¥æ”¶åç›´æ¥æ‰©å±•ï¼Œä½†ç»„ä»¶æœŸæœ›çš„æ˜¯ `tool_name` å­—æ®µ
- å¦‚æœ payload ä¸­æ²¡æœ‰æ˜ç¡®çš„ `tool_name`ï¼Œç»„ä»¶å°±æ— æ³•æ˜¾ç¤ºå·¥å…·åç§°

### 2. å·¥å…·ç»“æœæ›´æ–°é€»è¾‘ä¸å¤Ÿå¥å£®

**é—®é¢˜ä½ç½®**: `frontend/src/store/store.js` - `updateToolResult` action

```javascript
// åŸæœ‰é—®é¢˜ - å¤æ‚çš„æ•°ç»„æ“ä½œå®¹æ˜“å¤±è´¥
const toolCallIndex = lastMessage.toolCalls.map((tc, idx) => 
  tc.tool_name === toolName && tc.isExecuting ? idx : -1
).filter(idx => idx !== -1).pop();
```

**é—®é¢˜æè¿°**:
- ä½¿ç”¨ `map` + `filter` + `pop` çš„ç»„åˆå¯èƒ½å¯¼è‡´æŸ¥æ‰¾å¤±è´¥
- æ²¡æœ‰å›é€€é€»è¾‘å¤„ç†æ‰¾ä¸åˆ°çš„æƒ…å†µ
- å¤æ‚çš„é€»è¾‘éš¾ä»¥è°ƒè¯•

### 3. ç¼ºä¹è°ƒè¯•èƒ½åŠ›

**é—®é¢˜ä½ç½®**: æ•´ä¸ªå‰ç«¯å †æ ˆ

**é—®é¢˜æè¿°**:
- æ²¡æœ‰è¯¦ç»†çš„æ—¥å¿—è®°å½•å·¥å…·è°ƒç”¨è¿‡ç¨‹
- æ— æ³•è¿½è¸ªæ•°æ®ä»åç«¯åˆ°UIçš„å®Œæ•´æµç¨‹
- å‡ºé—®é¢˜æ—¶éš¾ä»¥å®šä½

## å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

### âœ… ä¿®å¤ 1: Redux Store - addToolCall Action

**æ–‡ä»¶**: `frontend/src/store/store.js` (è¡Œ 98-121)

```javascript
// ä¿®å¤å
addToolCall: (state, action) => {
  console.log('addToolCall action:', action.payload);
  const lastMessage = state.messages[state.messages.length - 1];
  console.log('æœ€åä¸€æ¡æ¶ˆæ¯:', lastMessage);
  if (lastMessage && lastMessage.isStreaming) {
    if (!lastMessage.toolCalls) {
      lastMessage.toolCalls = [];
    }
    
    // å…³é”®æ”¹è¿›ï¼šç¡®ä¿å·¥å…·è°ƒç”¨å¯¹è±¡åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µ
    const toolCall = {
      id: Date.now() + Math.random(),
      tool_name: action.payload.tool_name || action.payload.name || 'unknown',
      tool_arguments: action.payload.tool_arguments || action.payload.arguments || {},
      isExecuting: true,
      content: action.payload.content || '',
      ...action.payload,
    };
    
    console.log('æ·»åŠ å·¥å…·è°ƒç”¨:', toolCall);
    lastMessage.toolCalls.push(toolCall);
    console.log('å·¥å…·è°ƒç”¨åˆ—è¡¨:', lastMessage.toolCalls);
  } else {
    console.warn('æ— æ³•æ·»åŠ å·¥å…·è°ƒç”¨: æœ€åä¸€æ¡æ¶ˆæ¯ä¸å­˜åœ¨æˆ–ä¸åœ¨æµå¼çŠ¶æ€', {
      hasLastMessage: !!lastMessage,
      isStreaming: lastMessage?.isStreaming,
      payload: action.payload
    });
  }
}
```

**æ”¹è¿›ç‚¹**:
- âœ… æ˜¾å¼è®¾ç½® `tool_name` å’Œ `tool_arguments` å­—æ®µ
- âœ… æ”¯æŒå¤šç§å­—æ®µåï¼ˆå…¼å®¹æ€§æ›´å¥½ï¼‰
- âœ… ä¿ç•™åŸå§‹ `content` å­—æ®µ
- âœ… å¢å¼ºäº†é”™è¯¯æ—¥å¿—ä¿¡æ¯

### âœ… ä¿®å¤ 2: Redux Store - updateToolResult Action

**æ–‡ä»¶**: `frontend/src/store/store.js` (è¡Œ 123-155)

```javascript
// ä¿®å¤å - ä½¿ç”¨ç®€å•çš„åå‘å¾ªç¯
updateToolResult: (state, action) => {
  console.log('updateToolResult action:', action.payload);
  const lastMessage = state.messages[state.messages.length - 1];
  if (lastMessage && lastMessage.toolCalls && lastMessage.toolCalls.length > 0) {
    const toolName = action.payload.tool_name;
    
    // æ‰¾åˆ°åŒ¹é…çš„å·¥å…·è°ƒç”¨ï¼ˆä¼˜å…ˆæŸ¥æ‰¾æ­£åœ¨æ‰§è¡Œçš„ï¼‰
    let toolCallIndex = -1;
    
    for (let i = lastMessage.toolCalls.length - 1; i >= 0; i--) {
      if (lastMessage.toolCalls[i].tool_name === toolName && lastMessage.toolCalls[i].isExecuting) {
        toolCallIndex = i;
        break;
      }
    }
    
    // å›é€€ï¼šæ‰¾æœ€åä¸€ä¸ªåŒåçš„
    if (toolCallIndex === -1) {
      for (let i = lastMessage.toolCalls.length - 1; i >= 0; i--) {
        if (lastMessage.toolCalls[i].tool_name === toolName) {
          toolCallIndex = i;
          break;
        }
      }
    }
    
    console.log('æ‰¾åˆ°å·¥å…·è°ƒç”¨ç´¢å¼•:', toolCallIndex, 'å·¥å…·åç§°:', toolName);
    if (toolCallIndex >= 0) {
      lastMessage.toolCalls[toolCallIndex].isExecuting = false;
      lastMessage.toolCalls[toolCallIndex].result = action.payload;
      lastMessage.toolCalls[toolCallIndex].content = action.payload.content || '';
      console.log('å·¥å…·è°ƒç”¨ç»“æœå·²æ›´æ–°:', lastMessage.toolCalls[toolCallIndex]);
    } else {
      console.warn('æœªæ‰¾åˆ°åŒ¹é…çš„å·¥å…·è°ƒç”¨:', { ... });
    }
  }
}
```

**æ”¹è¿›ç‚¹**:
- âœ… æ¸…æ™°çš„å¾ªç¯é€»è¾‘ï¼Œæ˜“äºç†è§£å’Œè°ƒè¯•
- âœ… ä¼˜å…ˆæŸ¥æ‰¾æ­£åœ¨æ‰§è¡Œçš„å·¥å…·è°ƒç”¨
- âœ… åŒ…å«å›é€€é€»è¾‘
- âœ… æ›´è¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯

### âœ… ä¿®å¤ 3: Agent é¡µé¢æ·»åŠ è°ƒè¯•æ—¥å¿—

**æ–‡ä»¶**: `frontend/src/pages/Agent.jsx`

**åœ¨æ¶ˆæ¯æ¸²æŸ“ä¸­æ·»åŠ æ—¥å¿—**:
```javascript
messages.map((msg, idx) => {
  // è°ƒè¯•æ—¥å¿—ï¼šè®°å½•æ¯æ¡æ¶ˆæ¯çš„å·¥å…·è°ƒç”¨ä¿¡æ¯
  if (msg.role === 'assistant' && msg.toolCalls && msg.toolCalls.length > 0) {
    console.log(`æ¶ˆæ¯ ${idx} æœ‰${msg.toolCalls.length}ä¸ªå·¥å…·è°ƒç”¨:`, msg.toolCalls);
  }
  
  // åœ¨æ¸²æŸ“å·¥å…·è°ƒç”¨æ—¶ä¹Ÿæ·»åŠ æ—¥å¿—
  {msg.toolCalls.map((toolCall, toolIdx) => {
    console.log(`æ¸²æŸ“å·¥å…·è°ƒç”¨ ${toolIdx}:`, {
      id: toolCall.id,
      tool_name: toolCall.tool_name,
      isExecuting: toolCall.isExecuting,
      hasResult: !!toolCall.result
    });
    // ...
  })}
})
```

**åœ¨ API å›è°ƒä¸­æ·»åŠ è¯¦ç»†æ—¥å¿—**:
```javascript
// onToolCall - å·¥å…·è°ƒç”¨å›è°ƒ
(toolCallData) => {
  console.log('ğŸ”§ [API] æ”¶åˆ°å·¥å…·è°ƒç”¨:', {
    type: toolCallData.type,
    tool_name: toolCallData.tool_name,
    has_tool_arguments: !!toolCallData.tool_arguments,
  });
  console.log('ğŸ”§ [API] å·¥å…·è°ƒç”¨å®Œæ•´æ•°æ®:', toolCallData);
  dispatch(addToolCall(toolCallData));
}
```

**æ”¹è¿›ç‚¹**:
- âœ… ä½¿ç”¨ emoji å‰ç¼€åŒºåˆ†æ—¥å¿—ç±»å‹
- âœ… è®°å½•è¯¦ç»†çš„å·¥å…·ä¿¡æ¯
- âœ… ä¾¿äºåœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­ç­›é€‰æ—¥å¿—

### âœ… ä¿®å¤ 4: SSE æ•°æ®è§£ææ”¹è¿›

**æ–‡ä»¶**: `frontend/src/services/api.js` (è¡Œ 263-298)

```javascript
const processBuffer = (data) => {
  const lines = data.split('\n');
  
  lines.forEach(line => {
    line = line.trim();
    if (!line) return;
    
    if (line.startsWith('data: ')) {
      const jsonStr = line.slice(6).trim();
      if (!jsonStr) return;
      
      try {
        const parsed = JSON.parse(jsonStr);
        
        // æ·»åŠ æ—¥å¿—è®°å½•
        console.log('ğŸ“¡ [SSE Parser] æ”¶åˆ°æ•°æ®ç±»å‹:', parsed.type);
        
        if (parsed.type === 'tool_call') {
          console.log('ğŸ”§ [SSE Parser] è§£æå·¥å…·è°ƒç”¨:', {
            tool_name: parsed.tool_name,
            has_arguments: !!parsed.tool_arguments
          });
          onToolCall(parsed);
        } else if (parsed.type === 'tool_result') {
          console.log('âœ… [SSE Parser] è§£æå·¥å…·ç»“æœ:', {
            tool_name: parsed.tool_name,
            content_length: parsed.content ? parsed.content.length : 0
          });
          onToolResult(parsed);
        } else if (parsed.type === 'delta' && parsed.content !== undefined) {
          console.log('ğŸ“ [SSE Parser] å›ç­”å†…å®¹å¢é‡');
          onChunk(parsed.content);
        } else if (parsed.type === 'done') {
          console.log('ğŸ [SSE Parser] æµå¼å“åº”å®Œæˆä¿¡å·');
          onDone();
        } else if (parsed.type === 'error') {
          console.error('âŒ [SSE Parser] é”™è¯¯:', parsed.content);
          onError(parsed.content || parsed.error || 'æœªçŸ¥é”™è¯¯');
        } else {
          console.warn('âš ï¸ [SSE Parser] æœªå¤„ç†çš„æ¶ˆæ¯ç±»å‹:', parsed.type);
        }
      } catch (e) {
        console.error('âŒ [SSE Parser] JSON è§£æå¤±è´¥:', e);
        console.error('åŸå§‹æ•°æ®:', jsonStr);
      }
    }
  });
};
```

**æ”¹è¿›ç‚¹**:
- âœ… ä¸ºæ¯ä¸ªæ•°æ®ç±»å‹æ·»åŠ è¯¦ç»†æ—¥å¿—
- âœ… æ”¹è¿›é”™è¯¯å¤„ç†
- âœ… æ·»åŠ æœªå¤„ç†ç±»å‹çš„è­¦å‘Š

## éªŒè¯æ­¥éª¤

### ç¼–è¯‘éªŒè¯
- âœ… å‰ç«¯: `npm run build` æˆåŠŸæ„å»ºï¼Œæ— é”™è¯¯
- âœ… åç«¯: Python ä»£ç è¯­æ³•éªŒè¯é€šè¿‡

### æ•°æ®æµéªŒè¯

```
åç«¯å‘é€: {"type": "tool_call", "tool_name": "fetch_rss_news", "tool_arguments": {...}}
                        â†“
å‰ç«¯ SSE è§£æ: âœ… æ­£ç¡®è¯†åˆ« "tool_call" ç±»å‹
                        â†“
API å›è°ƒ: âœ… onToolCall(parsed) è¢«è°ƒç”¨
                        â†“
Redux dispatch: âœ… addToolCall(toolCallData) è¢« dispatch
                        â†“
Redux Store: âœ… æ·»åŠ åˆ° messages[n].toolCalls æ•°ç»„
                        â†“
React é‡æ–°æ¸²æŸ“: âœ… ToolCallCard ç»„ä»¶æ”¶åˆ°æ­£ç¡®çš„ props
                        â†“
UI æ˜¾ç¤º: âœ… å·¥å…·è°ƒç”¨å¡ç‰‡æ˜¾ç¤ºåœ¨å¯¹è¯ä¸­
```

## ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | è¡Œæ•° | æ”¹åŠ¨ç±»å‹ | è¯´æ˜ |
|------|------|--------|------|
| `frontend/src/store/store.js` | 98-121 | ä¿®æ”¹ | æ”¹è¿› `addToolCall` action æ•°æ®å¤„ç† |
| `frontend/src/store/store.js` | 123-155 | ä¿®æ”¹ | æ”¹è¿› `updateToolResult` action æŸ¥æ‰¾é€»è¾‘ |
| `frontend/src/pages/Agent.jsx` | 350-406 | ä¿®æ”¹ | æ·»åŠ è°ƒè¯•æ—¥å¿—ï¼Œæ”¹è¿›å·¥å…·è°ƒç”¨æ˜¾ç¤º |
| `frontend/src/pages/Agent.jsx` | 165-214 | ä¿®æ”¹ | æ·»åŠ è¯¦ç»†çš„ API å›è°ƒæ—¥å¿— |
| `frontend/src/services/api.js` | 263-298 | ä¿®æ”¹ | æ”¹è¿› SSE æ•°æ®è§£æå’Œæ—¥å¿—è®°å½• |

## é¢„æœŸæ•ˆæœ

ä¿®å¤å®Œæˆåï¼Œåœ¨ Agent é¡µé¢è°ƒç”¨å·¥å…·æ—¶åº”è¯¥èƒ½å¤Ÿçœ‹åˆ°ï¼š

1. **æµè§ˆå™¨æ§åˆ¶å°**ä¸­è¯¦ç»†çš„æ—¥å¿—åºåˆ—ï¼Œè¿½è¸ªå®Œæ•´çš„å·¥å…·è°ƒç”¨è¿‡ç¨‹
2. **UI ä¸­**å®æ—¶æ˜¾ç¤ºå·¥å…·è°ƒç”¨å¡ç‰‡ï¼ŒåŒ…æ‹¬ï¼š
   - å·¥å…·åç§°
   - å·¥å…·å‚æ•°ï¼ˆå±•å¼€åå¯è§ï¼‰
   - æ‰§è¡ŒçŠ¶æ€ï¼ˆæ‰§è¡Œä¸­/æ‰§è¡Œå®Œæˆ/æ‰§è¡Œå¤±è´¥ï¼‰
   - æ‰§è¡Œç»“æœï¼ˆå®Œæˆåå¯è§ï¼‰
3. **å†å²æ¶ˆæ¯**ä¸­ä¿ç•™å·¥å…·è°ƒç”¨ä¿¡æ¯

## æ•…éšœæ’é™¤æŒ‡å—

å¦‚æœä»ç„¶çœ‹ä¸åˆ°å·¥å…·è°ƒç”¨å¡ç‰‡ï¼Œå¯ä»¥æŒ‰ç…§ä»¥ä¸‹é¡ºåºæ£€æŸ¥ï¼š

1. **æ£€æŸ¥ Network æ ‡ç­¾**ï¼šç¡®è®¤ SSE æµä¸­æ˜¯å¦åŒ…å« `"type":"tool_call"` çš„æ•°æ®
2. **æ£€æŸ¥ Console æ—¥å¿—**ï¼šç¡®è®¤æ˜¯å¦çœ‹åˆ°å·¥å…·è°ƒç”¨ç›¸å…³çš„æ—¥å¿—
3. **æ£€æŸ¥ Redux çŠ¶æ€**ï¼šä½¿ç”¨ Redux DevTools æ£€æŸ¥ `messages` æ•°ç»„ä¸­æ˜¯å¦åŒ…å« `toolCalls`
4. **æ£€æŸ¥æµè§ˆå™¨ç¼“å­˜**ï¼šæ¸…é™¤ç¼“å­˜ååˆ·æ–°é¡µé¢

## æ–‡æ¡£é“¾æ¥

- è¯¦ç»†ä¿®å¤è¯´æ˜: `docs/frontend/å·¥å…·è°ƒç”¨æ˜¾ç¤ºä¿®å¤_2026-01-22.md`
- æµ‹è¯•æŒ‡å—: `docs/frontend/å·¥å…·è°ƒç”¨æ˜¾ç¤ºæµ‹è¯•æŒ‡å—_2026-01-22.md`

## æ€»ç»“

é€šè¿‡ä»¥ä¸Šä¿®å¤ï¼Œæˆ‘ä»¬è§£å†³äº†ä»¥ä¸‹é—®é¢˜ï¼š

1. âœ… **æ•°æ®æ ¼å¼ä¸ä¸€è‡´**: ç¡®ä¿å·¥å…·è°ƒç”¨å¯¹è±¡åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µ
2. âœ… **çŠ¶æ€æ›´æ–°é€»è¾‘ç¼ºé™·**: æ”¹è¿›æŸ¥æ‰¾å’Œæ›´æ–°å·¥å…·è°ƒç”¨çš„é€»è¾‘
3. âœ… **ç¼ºä¹è°ƒè¯•èƒ½åŠ›**: æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œä¾¿äºé—®é¢˜è¯Šæ–­
4. âœ… **ä»£ç å¯ç»´æŠ¤æ€§**: ç®€åŒ–å¤æ‚çš„ä¸šåŠ¡é€»è¾‘ï¼Œæé«˜ä»£ç æ¸…æ™°åº¦

ä¿®å¤çš„æ•´ä½“æ€è·¯æ˜¯ï¼š**ç¡®ä¿æ•°æ®æ ¼å¼çš„ä¸€è‡´æ€§ï¼Œæ”¹è¿›çŠ¶æ€ç®¡ç†çš„å¥å£®æ€§ï¼Œæ·»åŠ å……åˆ†çš„è°ƒè¯•æ—¥å¿—ã€‚**
