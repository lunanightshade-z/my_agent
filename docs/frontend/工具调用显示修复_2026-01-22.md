# Agenté¡µé¢å·¥å…·è°ƒç”¨æ˜¾ç¤ºä¿®å¤ (2026-01-22)

## é—®é¢˜æè¿°
Agenté¡µé¢åœ¨è°ƒç”¨å·¥å…·æ—¶ï¼Œå‰ç«¯æ²¡æœ‰ä»»ä½•æ˜¾ç¤ºå·¥å…·è°ƒç”¨çš„å¡ç‰‡æˆ–ä¿¡æ¯ã€‚

## æ ¹æœ¬åŸå› åˆ†æ

1. **æ•°æ®æ ¼å¼ä¸åŒ¹é…**ï¼šRedux store ä¸­çš„ `addToolCall` action æ²¡æœ‰ç¡®ä¿å·¥å…·è°ƒç”¨å¯¹è±¡åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µ (`tool_name` å’Œ `tool_arguments`)

2. **çŠ¶æ€æ›´æ–°é€»è¾‘ç¼ºé™·**ï¼š`updateToolResult` action ä½¿ç”¨å¤æ‚çš„æ•°ç»„æ˜ å°„æ–¹å¼ï¼Œå®¹æ˜“å‡ºç°ç´¢å¼•åŒ¹é…å¤±è´¥

3. **ç¼ºä¹è°ƒè¯•æ—¥å¿—**ï¼šæ•´ä¸ªæ•°æ®æµä¸­ç¼ºä¹è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œå¯¼è‡´æ— æ³•è¿½è¸ªé—®é¢˜

4. **é”™è¯¯å¤„ç†ä¸å¤Ÿå¥å£®**ï¼šSSE æ•°æ®è§£ææ—¶æ²¡æœ‰å……åˆ†çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—

## ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤ `frontend/src/store/store.js` ä¸­çš„ `addToolCall` action

**é—®é¢˜**ï¼šåŸä»£ç ç›´æ¥ä½¿ç”¨ `...action.payload` æ‰©å±•å¯¹è±¡ï¼Œä½†æ²¡æœ‰ç¡®ä¿ `tool_name` å­—æ®µè¢«æ­£ç¡®è®¾ç½®

**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
// ä¿®æ”¹å‰
const toolCall = {
  ...action.payload,
  id: Date.now() + Math.random(),
  isExecuting: true,
};

// ä¿®æ”¹å
const toolCall = {
  id: Date.now() + Math.random(),
  tool_name: action.payload.tool_name || action.payload.name || 'unknown', // æ”¯æŒå¤šç§å­—æ®µå
  tool_arguments: action.payload.tool_arguments || action.payload.arguments || {}, // æ”¯æŒå¤šç§å­—æ®µå
  isExecuting: true,
  content: action.payload.content || '',
  ...action.payload,
};
```

**å…³é”®æ”¹è¿›**ï¼š
- æ˜¾å¼è®¾ç½® `tool_name` å’Œ `tool_arguments` å­—æ®µ
- æ”¯æŒå¤šç§å­—æ®µåç§°ï¼ˆ`tool_name`/`name`ï¼Œ`tool_arguments`/`arguments`ï¼‰
- ä¿ç•™åŸå§‹ `content` å­—æ®µ
- å¢å¼ºäº†é”™è¯¯æ—¥å¿—

### 2. ä¿®å¤ `frontend/src/store/store.js` ä¸­çš„ `updateToolResult` action

**é—®é¢˜**ï¼šåŸä»£ç ä½¿ç”¨ `map` + `filter` + `pop` çš„å¤æ‚æ–¹å¼æ‰¾ç´¢å¼•ï¼Œå®¹æ˜“å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
```javascript
// æ”¹è¿›åçš„å¾ªç¯æ–¹å¼
let toolCallIndex = -1;

// å…ˆå°è¯•æ‰¾åˆ°æ­£åœ¨æ‰§è¡Œçš„åŒåå·¥å…·è°ƒç”¨
for (let i = lastMessage.toolCalls.length - 1; i >= 0; i--) {
  if (lastMessage.toolCalls[i].tool_name === toolName && lastMessage.toolCalls[i].isExecuting) {
    toolCallIndex = i;
    break;
  }
}

// å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ­£åœ¨æ‰§è¡Œçš„ï¼Œæ‰¾æœ€åä¸€ä¸ªåŒåçš„
if (toolCallIndex === -1) {
  for (let i = lastMessage.toolCalls.length - 1; i >= 0; i--) {
    if (lastMessage.toolCalls[i].tool_name === toolName) {
      toolCallIndex = i;
      break;
    }
  }
}
```

**å…³é”®æ”¹è¿›**ï¼š
- ä½¿ç”¨ç®€å•çš„åå‘å¾ªç¯ä»£æ›¿å¤æ‚çš„æ•°ç»„æ–¹æ³•
- æ›´å®¹æ˜“ç†è§£å’Œè°ƒè¯•
- æ›´ä¸¥è°¨çš„åŒ¹é…é€»è¾‘

### 3. åœ¨ `frontend/src/pages/Agent.jsx` ä¸­æ·»åŠ è°ƒè¯•æ—¥å¿—

**æ”¹è¿›ç‚¹**ï¼š
- åœ¨æ¶ˆæ¯æ¸²æŸ“æ—¶æ·»åŠ å·¥å…·è°ƒç”¨ä¿¡æ¯çš„æ—¥å¿—
- åœ¨ API å›è°ƒä¸­æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•
- åŒºåˆ†ä¸åŒçš„æ“ä½œé˜¶æ®µï¼ˆé€šè¿‡ emoji å‰ç¼€åŒºåˆ†ï¼‰

```javascript
// åœ¨ onToolCall å›è°ƒä¸­
console.log('ğŸ”§ [API] æ”¶åˆ°å·¥å…·è°ƒç”¨:', {
  type: toolCallData.type,
  tool_name: toolCallData.tool_name,
  has_tool_arguments: !!toolCallData.tool_arguments,
  arguments_keys: toolCallData.tool_arguments ? Object.keys(toolCallData.tool_arguments) : []
});

// åœ¨æ¶ˆæ¯æ¸²æŸ“ä¸­
if (msg.role === 'assistant' && msg.toolCalls && msg.toolCalls.length > 0) {
  console.log(`æ¶ˆæ¯ ${idx} æœ‰${msg.toolCalls.length}ä¸ªå·¥å…·è°ƒç”¨:`, msg.toolCalls);
}
```

### 4. æ”¹è¿› `frontend/src/services/api.js` ä¸­çš„ SSE è§£æé€»è¾‘

**æ”¹è¿›ç‚¹**ï¼š
- æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•æ¯ä¸ªæ•°æ®ç±»å‹
- æ”¹è¿›é”™è¯¯å¤„ç†
- æ·»åŠ æœªå¤„ç†ç±»å‹çš„è­¦å‘Š

```javascript
if (parsed.type === 'tool_call') {
  console.log('ğŸ”§ [SSE Parser] è§£æå·¥å…·è°ƒç”¨:', {
    tool_name: parsed.tool_name,
    has_arguments: !!parsed.tool_arguments
  });
  console.log('ğŸ”§ [SSE Parser] å·¥å…·è°ƒç”¨å®Œæ•´æ•°æ®:', parsed);
  onToolCall(parsed);
}
```

## æ•°æ®æµéªŒè¯

```
åç«¯ (agent.py)
  â†“ yield {"type": "tool_call", "tool_name": "...", "tool_arguments": {...}}
  â†“
åç«¯æœåŠ¡å±‚ (agent_service.py)
  â†“ yield {"type": "tool_call", "tool_name": "...", "tool_arguments": {...}}
  â†“
API ç«¯ç‚¹ (agent.py - SSE)
  â†“ data: {"type": "tool_call", ...}
  â†“
å‰ç«¯ API æœåŠ¡ (api.js)
  â†“ è§£æ JSONï¼Œè°ƒç”¨ onToolCall(parsed)
  â†“
Agent é¡µé¢ (Agent.jsx)
  â†“ dispatch(addToolCall(toolCallData))
  â†“
Redux Store (store.js)
  â†“ æ·»åŠ åˆ°æ¶ˆæ¯çš„ toolCalls æ•°ç»„
  â†“
React ç»„ä»¶é‡æ–°æ¸²æŸ“
  â†“ æ˜¾ç¤º ToolCallCard ç»„ä»¶
```

## å…³é”®æ£€æŸ¥ç‚¹

âœ… **å·¥å…·è°ƒç”¨æ•°æ®æ ¼å¼**
- åç«¯å‘é€ï¼š`{"type": "tool_call", "tool_name": "...", "tool_arguments": {...}}`
- å‰ç«¯æœŸæœ›ï¼šåŒä¸Š

âœ… **Redux çŠ¶æ€ç®¡ç†**
- `addToolCall` action ç¡®ä¿è®¾ç½® `tool_name` å’Œ `tool_arguments` å­—æ®µ
- `updateToolResult` action ä½¿ç”¨æ›´å¯é çš„åŒ¹é…é€»è¾‘

âœ… **SSE æ•°æ®è§£æ**
- `api.js` æ­£ç¡®è¯†åˆ« `tool_call` ç±»å‹
- è°ƒç”¨æ­£ç¡®çš„å›è°ƒå‡½æ•°ä¼ é€’æ•°æ®

âœ… **ç»„ä»¶æ¸²æŸ“**
- `Agent.jsx` æ£€æŸ¥ `msg.toolCalls` å¹¶è°ƒç”¨ `ToolCallCard` ç»„ä»¶
- æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

## æµ‹è¯•æ–¹æ³•

1. **æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·**ï¼Œè¿›å…¥ Console æ ‡ç­¾

2. **å‘é€ä¸€ä¸ªä¼šè§¦å‘å·¥å…·è°ƒç”¨çš„æ¶ˆæ¯**ï¼Œä¾‹å¦‚ï¼š
   ```
   "è·å–æœ€æ–°çš„æ–°é—»"
   ```

3. **æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—**ï¼Œåº”è¯¥çœ‹åˆ°ï¼š
   ```
   ğŸ”§ [API] æ”¶åˆ°å·¥å…·è°ƒç”¨: {...}
   addToolCall action: {...}
   æ¶ˆæ¯ 1 æœ‰1ä¸ªå·¥å…·è°ƒç”¨: [...]
   ğŸ”§ [SSE Parser] è§£æå·¥å…·è°ƒç”¨: {...}
   ```

4. **æ£€æŸ¥ UI**ï¼Œåº”è¯¥æ˜¾ç¤ºå·¥å…·è°ƒç”¨å¡ç‰‡ï¼Œæ˜¾ç¤ºï¼š
   - å·¥å…·åç§°
   - å·¥å…·å‚æ•°
   - æ‰§è¡ŒçŠ¶æ€
   - æ‰§è¡Œç»“æœï¼ˆå®Œæˆåï¼‰

## å¯èƒ½çš„è°ƒè¯•æ­¥éª¤

å¦‚æœå·¥å…·è°ƒç”¨ä»ç„¶ä¸æ˜¾ç¤ºï¼Œå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è°ƒè¯•ï¼š

1. **æ£€æŸ¥ SSE æµ**ï¼šåœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„ Network æ ‡ç­¾ä¸­æŸ¥çœ‹ `/agent/stream` è¯·æ±‚ï¼Œæ£€æŸ¥å“åº”æ•°æ®æ˜¯å¦åŒ…å« `tool_call` ç±»å‹

2. **æ£€æŸ¥ Redux çŠ¶æ€**ï¼šä½¿ç”¨ Redux DevTools æ£€æŸ¥ store ä¸­çš„çŠ¶æ€ï¼Œç¡®ä¿ `messages` æ•°ç»„ä¸­æœ€åä¸€æ¡æ¶ˆæ¯çš„ `toolCalls` å­—æ®µæ˜¯å¦åŒ…å«å·¥å…·è°ƒç”¨

3. **æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—**ï¼šæŸ¥çœ‹ Console æ ‡ç­¾ä¸­çš„è¯¦ç»†æ—¥å¿—ï¼ŒæŒ‰ç…§ emoji å‰ç¼€è¿‡æ»¤ï¼š
   - ğŸ”§ï¼šå·¥å…·è°ƒç”¨ç›¸å…³
   - âœ…ï¼šå·¥å…·ç»“æœç›¸å…³
   - ğŸ“ï¼šå†…å®¹ç›¸å…³
   - ğŸ“¡ï¼šSSE è§£æç›¸å…³

4. **æ£€æŸ¥ ToolCallCard ç»„ä»¶**ï¼šç¡®ä¿ç»„ä»¶æ¥æ”¶åˆ°äº†æ­£ç¡®çš„ propsï¼Œç‰¹åˆ«æ˜¯ `toolCall` å¯¹è±¡å¿…é¡»åŒ…å« `tool_name` å’Œ `tool_arguments` å­—æ®µ

## ç›¸å…³æ–‡ä»¶

- `frontend/src/store/store.js` - Redux çŠ¶æ€ç®¡ç†
- `frontend/src/pages/Agent.jsx` - Agent é¡µé¢ç»„ä»¶
- `frontend/src/services/api.js` - API æœåŠ¡
- `frontend/src/components/chat/ToolCallCard/ToolCallCard.jsx` - å·¥å…·è°ƒç”¨å¡ç‰‡ç»„ä»¶
- `backend/agents/agent.py` - åç«¯æ™ºèƒ½ä½“å®ç°
- `backend/app/services/agent_service.py` - åç«¯æœåŠ¡å±‚

## åç»­ä¼˜åŒ–å»ºè®®

1. **è€ƒè™‘æ·»åŠ å·¥å…·è°ƒç”¨çš„æœ¬åœ°å­˜å‚¨**ï¼Œä»¥ä¾¿å†å²æŸ¥çœ‹
2. **æ·»åŠ å·¥å…·è°ƒç”¨çš„è¶…æ—¶å¤„ç†**
3. **æ”¹è¿›å·¥å…·ç»“æœçš„é”™è¯¯å±•ç¤º**
4. **è€ƒè™‘ç¼“å­˜å·¥å…·ç»“æœï¼Œé¿å…é‡å¤è°ƒç”¨**
